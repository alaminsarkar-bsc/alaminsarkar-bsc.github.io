<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iPray - বিশ্বাসের উঠোন</title>
    
    <!-- Meta Tags -->
    <meta property="og:title" content="iPray - বিশ্বাসের উঠোন">
    <meta property="og:description" content="আপনার মনের দোয়া শেয়ার করুন এবং অন্যদের জন্য দোয়া করুন।">
    <meta property="og:image" content="https://pnsvptaanvtdaspqjwbk.supabase.co/storage/v1/object/public/post_images/default_banner.jpg">
    <meta property="og:url" content="https://doa-angina.vercel.app/">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="iPray">
    
    <!-- PWA Settings -->
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    
    <!-- CSS Links -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">

    <!-- OneSignal SDK (Push Notification) -->
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(function(OneSignal) {
        OneSignal.init({
          appId: "f32cfd0e-9004-4b77-99e1-0a668f4b0df4",
          safari_web_id: "web.onesignal.auto.66a2c26d-209a-4720-9720-e2220d937000",
          notifyButton: {
            enable: false,
          },
          allowLocalhostAsSecureOrigin: true,
        });
      });
    </script>
</head>
<body id="home-page">

    <!-- Offline Indicator -->
    <div id="offlineIndicator" class="offline-indicator" style="display: none;"></div>

    <!-- ========================================= -->
    <!-- ADMIN LINKS (Hidden by default)           -->
    <!-- ========================================= -->
    <a href="/admin.html" id="adminLink" style="display: none; position: fixed; top: 110px; right: 20px; z-index: 1000; background: #2c3e50; color: white; padding: 8px 12px; border-radius: 20px; text-decoration: none; font-size: 13px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
        <i class="fas fa-shield-alt"></i> Admin
    </a>
    
    <a href="/campaign-admin.html" id="campaignAdminLink" style="display: none; position: fixed; top: 150px; right: 20px; z-index: 1000; background: #27ae60; color: white; padding: 8px 12px; border-radius: 20px; text-decoration: none; font-size: 13px;">
        <i class="fas fa-tasks"></i> Campaign
    </a>

    <!-- ========================================= -->
    <!-- LOGIN MODAL (Global Auth)                 -->
    <!-- ========================================= -->
    <div id="loginPage" style="display: none;">
        <div class="login-box">
            <h1>iPray</h1>
            <p>বিশ্বাস ও দোয়ার এক অনন্য মেলবন্ধন। এগিয়ে যেতে লগইন করুন।</p>
            
            <button id="googleSignInBtn">
                <i class="fab fa-google"></i> গুগল দিয়ে সাইন ইন করুন
            </button>
            
            <button id="facebookSignInBtn" class="facebook-btn">
                <i class="fab fa-facebook-f"></i> ফেসবুক দিয়ে সাইন ইন করুন
            </button>
            
            <div class="login-divider">অথবা</div>
            
            <div id="phoneLoginContainer">
                <!-- Step 1: Phone Input -->
                <div id="phoneInputStep">
                    <input type="tel" id="phoneInput" class="login-input" placeholder="মোবাইল নাম্বার (+880...)" />
                    <button id="sendOtpBtn" class="phone-login-btn">ওটিপি পাঠান</button>
                </div>
                
                <!-- Step 2: OTP Input -->
                <div id="otpInputStep" style="display: none;">
                    <input type="text" id="otpInput" class="login-input" placeholder="৬ ডিজিটের কোড" />
                    <button id="verifyOtpBtn" class="phone-login-btn">যাচাই করুন</button>
                    <button id="backToPhoneBtn" class="text-btn">নাম্বার পরিবর্তন</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================= -->
    <!-- MAIN APP CONTAINER                        -->
    <!-- ========================================= -->
    <div id="appContainer" style="display: none;"> <!-- Default Hidden to prevent flash -->
        
        <!-- HEADER SECTION -->
        <div class="header-container">
            
            <!-- Top Row: Logo & Search & Actions -->
            <div class="header-top-row">
                <a href="/index.html" class="logo-link">iPray</a>
                
                <!-- Floating Search Box (Hidden by default) -->
                <input type="search" id="searchInput" class="floating-search-box" placeholder="খুঁজুন...">

                <div class="header-actions-top">
                    <!-- Islamic Tools Link -->
                    <a href="islamic.html" class="top-icon-btn" title="কুরআন, হাদিস ও নামাজের সময়">
                        <i class="fas fa-book-open" style="color: #8e44ad;"></i>
                    </a>
                    
                    <!-- Messenger Link (With Badge) -->
                    <a href="messages.html" class="top-icon-btn" title="মেসেঞ্জার" style="position: relative;">
                        <i class="fab fa-facebook-messenger" style="color: #0084ff;"></i>
                        <!-- Unread Message Badge -->
                        <span id="msg-badge-count" style="display:none; position:absolute; top:-5px; right:-5px; background:red; color:white; font-size:10px; padding:2px 5px; border-radius:50%; min-width: 10px; text-align: center;">0</span>
                    </a>
                    
                    <!-- Create Story Button -->
                    <button id="createStoryBtn" class="top-icon-btn" title="স্টোরি তৈরি করুন">
                        <i class="fas fa-plus" style="color: #27ae60;"></i>
                    </button>
                    
                    <!-- Search Trigger Button -->
                    <button id="searchBtn" class="top-icon-btn" title="খুঁজুন">
                        <i class="fas fa-search"></i>
                    </button>
                    
                    <!-- Global Donate/Support Button -->
                    <button id="globalDonateBtn" class="top-icon-btn" title="সাপোর্ট">
                        <i class="fas fa-hand-holding-heart" style="color: #e74c3c;"></i>
                    </button>
                </div>
            </div>

            <!-- Bottom Row: Navigation Tabs -->
            <div class="header-nav-row">
                <!-- Home Tab -->
                <a href="/index.html" class="nav-tab active" id="homeTabBtn">
                    <i class="fas fa-home"></i>
                </a>
                
                <!-- Shorts Video Button -->
                <button id="videoFeedBtn" class="nav-tab">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="display: block; margin: auto;">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M17.77 10.32L16.57 9.82L18 9.06C19.78 8.12 20.46 5.91 19.52 4.13C18.58 2.35 16.37 1.67 14.59 2.61L6.09 6.94C4.31 7.88 3.63 10.09 4.57 11.87C5.03 12.75 5.82 13.33 6.74 13.56L7.94 14.06L6.5 14.82C4.72 15.76 4.04 17.97 4.98 19.75C5.92 21.53 8.13 22.21 9.91 21.27L18.41 16.94C20.19 16 20.87 13.79 19.93 12.01C19.47 11.13 18.69 10.55 17.77 10.32ZM10 14.65V9.35L15 12L10 14.65Z" />
                    </svg>
                </button>

                <!-- Feed Filter Toggle (All/Following) -->
                <button id="feedToggleBtn" class="nav-tab">
                    <i class="fas fa-users"></i>
                </button>
                
                <!-- Create Post Link -->
                <a href="post.html" class="nav-tab" id="addPostLink" title="পোস্ট করুন">
                    <i class="fas fa-plus-circle" style="font-size: 28px; color: var(--text-color);"></i>
                </a>

                <!-- Notification Tab -->
                <div class="notification-wrapper">
                    <button id="notificationBtn" class="nav-tab">
                        <i class="fas fa-bell"></i>
                        <span id="notification-badge" class="notification-badge" style="display: none;"></span>
                    </button>
                </div>
                
                <!-- Profile Tab -->
                <a href="/profile.html" class="nav-tab">
                    <i class="fas fa-user-circle"></i>
                </a>
            </div>
        </div>

        <!-- MAIN CONTENT AREA -->
        <main id="main-content" class="main-view">
            
            <!-- Story Skeleton Loader (When loading) -->
            <div id="storySkeletonContainer" class="story-container">
                <div class="skeleton-story"></div>
                <div class="skeleton-story"></div>
                <div class="skeleton-story"></div>
                <div class="skeleton-story"></div>
            </div>

            <!-- Real Story Container (Populated by JS) -->
            <div id="storyContainer" class="story-container" style="display: none;"></div>
            
            <!-- Feed Skeleton Loader -->
            <div id="skeletonContainer">
                <div class="skeleton-card">
                    <div class="skeleton-header">
                        <div class="skeleton-avatar"></div>
                        <div class="skeleton-author-info">
                            <div class="skeleton-line" style="width: 50%;"></div>
                            <div class="skeleton-line" style="width: 30%;"></div>
                        </div>
                    </div>
                    <div class="skeleton-line" style="width: 90%;"></div>
                    <div class="skeleton-line" style="width: 70%;"></div>
                    <div class="skeleton-block" style="height: 200px;"></div>
                </div>
            </div>

            <!-- Main Feed Container -->
            <div class="feed-container" id="feedContainer"></div>
            
            <!-- Bottom Loading Indicator -->
            <div id="loadingIndicator" style="text-align: center; padding: 20px; display: none; color: var(--light-text);">
                <div class="loader" style="border-color: #999; border-bottom-color: transparent;"></div>
            </div>
        </main>
    </div>

    <!-- ========================================= -->
    <!-- MODALS SECTION                            -->
    <!-- ========================================= -->

    <!-- 1. ADVANCED STORY EDITOR MODAL -->
    <div id="storyCreateModal" class="story-editor-modal" style="display: none;">
        <div class="editor-container">
            <!-- Top Bar -->
            <div class="editor-top-bar">
                <button class="icon-btn close-editor" id="closeStoryEditorBtn">
                    <i class="fas fa-times"></i>
                </button>
                
                <div class="editor-tabs-center">
                    <button class="editor-tab-btn active" id="tabTextBtn">লেখা</button>
                    <button class="editor-tab-btn" id="tabMediaBtn">মিডিয়া</button>
                </div>
                
                <div class="editor-top-actions">
                    <button class="icon-btn" id="storyMuteBtn" style="display:none;">
                        <i class="fas fa-microphone"></i>
                    </button>
                </div>
            </div>

            <!-- Canvas Area -->
            <div class="editor-canvas-area">
                <!-- Text Mode Canvas -->
                <div id="textCanvas" class="story-canvas" style="display: flex;">
                    <div class="canvas-content">
                        <div id="storyTextInput" class="draggable-text" contenteditable="true" spellcheck="false" data-placeholder="এখানে লিখুন..."></div>
                    </div>
                    <div class="watermark"><i class="fas fa-praying-hands"></i> iPray</div>
                </div>
                
                <!-- Media Mode Canvas -->
                <div id="mediaCanvas" class="story-canvas" style="display: none; background: #000;">
                    <video id="liveCameraFeed" autoplay muted playsinline style="display:none; width:100%; height:100%; object-fit:cover; transform: scaleX(-1);"></video>
                    <img id="storyImgPreview" style="display: none; width: 100%; height: 100%; object-fit: contain;">
                    <video id="storyVidPreview" style="display: none; width: 100%; height: 100%; object-fit: contain;" playsinline loop></video>
                    
                    <!-- Media Placeholder / Upload Buttons -->
                    <div id="mediaPlaceholder" class="media-placeholder-content">
                        <div class="media-upload-options">
                            <label for="storyFileUpload" class="upload-trigger-btn">
                                <div class="upload-icon-circle"><i class="fas fa-images"></i></div>
                                <span>গ্যালারি</span>
                            </label>
                            
                            <button id="openCameraBtn" class="upload-trigger-btn" style="background:none; border:none;">
                                <div class="upload-icon-circle"><i class="fas fa-camera"></i></div>
                                <span>ক্যামেরা</span>
                            </button>
                            
                            <input type="file" id="storyFileUpload" accept="image/*,video/*" hidden>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar Tools (For Text Mode) -->
            <div class="editor-sidebar" id="textModeTools">
                <div class="tool-item" id="storyBgColorBtn">
                    <div class="tool-icon" style="background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%); border: none;"></div>
                    <span>ব্যাকগ্রাউন্ড</span>
                </div>
            </div>

            <!-- Bottom Bar -->
            <div class="editor-bottom-bar">
                <!-- Caption Input -->
                <div id="mediaCaptionContainer" style="display: none; width: 100%; margin-bottom: 10px;">
                    <input type="text" id="storyCaptionInput" placeholder="ক্যাপশন লিখুন..." class="story-caption-input">
                </div>
                
                <!-- Recording Button Area -->
                <div id="recordingArea" style="display:none; justify-content:center; margin-bottom: 15px;">
                    <button id="recordBtn" class="record-btn-ring">
                        <svg class="progress-ring" width="80" height="80">
                            <circle class="progress-ring__circle" stroke="white" stroke-width="4" fill="transparent" r="36" cx="40" cy="40"/>
                        </svg>
                        <div class="record-inner-dot"></div>
                    </button>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons-row">
                    <button id="resetMediaBtn" class="editor-btn secondary" style="display:none;">
                        <i class="fas fa-trash"></i> বাতিল
                    </button>
                    
                    <button id="publishStoryBtn" class="editor-btn primary" style="flex: 1; justify-content: center;">
                        স্টোরিতে শেয়ার করুন <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. Edit Post Modal -->
    <div id="editPrayerModal" class="modal">
        <div class="modal-content">
            <form id="editPrayerForm">
                <div class="modal-header">
                    <h2 class="modal-title">পোস্ট সম্পাদনা</h2>
                    <span class="close-btn" onclick="document.getElementById('editPrayerModal').style.display='none'">&times;</span>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editPrayerId">
                    <div class="form-group">
                        <label>শিরোনাম</label>
                        <input type="text" id="editPrayerTitleInput" required>
                    </div>
                    <div class="form-group">
                        <label>বিস্তারিত</label>
                        <textarea id="editPrayerDetailsTextarea" rows="5" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>ইউটিউব লিংক (ঐচ্ছিক)</label>
                        <input type="text" id="editYoutubeLinkInput">
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="savePrayerBtn" type="submit">সেভ করুন</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 3. Report Modal -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">রিপোর্ট করুন</h2>
                <span class="close-btn" onclick="document.getElementById('reportModal').style.display='none'">&times;</span>
            </div>
            <div class="modal-body">
                <form id="reportForm">
                    <input type="hidden" id="reportContentId">
                    <input type="hidden" id="reportContentType">
                    <div class="form-group">
                        <label>কারণ নির্বাচন করুন</label>
                        <select id="reportCategory" required>
                            <option value="">নির্বাচন করুন...</option>
                            <option value="SPAM">স্প্যাম</option>
                            <option value="HARASSMENT">হারাসমেন্ট</option>
                            <option value="HATE_SPEECH">ঘৃণামূলক বক্তব্য</option>
                            <option value="INAPPROPRIATE">অনুপযুক্ত</option>
                            <option value="OTHER">অন্যান্য</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <textarea id="reportDescription" rows="3" placeholder="বিস্তারিত..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="submitReportBtn">রিপোর্ট জমা দিন</button>
            </div>
        </div>
    </div>

    <!-- 4. General Donation Modal -->
    <div id="generalDonationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">iPray সাপোর্ট</h2>
                <span class="close-btn" onclick="document.getElementById('generalDonationModal').style.display='none'">&times;</span>
            </div>
            
            <div class="profile-tabs" style="margin-bottom:15px;">
                <button class="tab-btn active" onclick="switchDonationTab('donate')">ডোনেট</button>
                <button class="tab-btn" onclick="switchDonationTab('history')">হিস্ট্রি</button>
            </div>
            
            <div class="modal-body">
                <!-- Donate Tab Content -->
                <div id="donateTabContent">
                    <div id="adminPaymentMethods" class="payment-methods"></div>
                    
                    <div id="genPaymentForm" style="display:none; margin-top:15px; border-top:1px solid #eee; padding-top:15px;">
                        <div class="number-display">
                            <b><span id="genMethodName"></span></b>: 
                            <span id="genTargetNumber" style="color:#e74c3c;"></span> 
                            <i class="fas fa-copy" onclick="copyGenNumber()" style="cursor:pointer; margin-left:10px;"></i>
                        </div>
                        
                        <form id="submitGeneralDonation">
                            <div class="form-group">
                                <input type="number" id="genAmount" placeholder="টাকার পরিমাণ" required>
                            </div>
                            <div class="form-group">
                                <input type="text" id="genSender" placeholder="প্রেরক নাম্বার" required>
                            </div>
                            <div class="form-group">
                                <input type="text" id="genTrxId" placeholder="TrxID" required>
                            </div>
                            <button type="submit" class="btn-full-width">জমা দিন</button>
                        </form>
                    </div>
                </div>
                
                <!-- History Tab Content -->
                <div id="historyTabContent" style="display:none;">
                    <div id="donationHistoryList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. Campaign Donation Details Modal -->
    <div id="donationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">সহায়তা পাঠান</h2>
                <span class="close-btn" onclick="document.getElementById('donationModal').style.display='none'">&times;</span>
            </div>
            <div class="modal-body" id="donationDetailsBody">
                <!-- Content injected via JS -->
            </div>
        </div>
    </div>

    <!-- 6. Notification Modal -->
    <div id="notificationModal" class="notification-modal">
        <div class="notification-modal-content">
            <div class="notification-modal-header">
                <button id="closeNotificationModalBtn" class="back-btn-modal">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="modal-title">নোটিফিকেশন</h2>
                <div class="header-actions">
                    <button id="mark-all-read-btn-modal" class="mark-all-read-btn-modal">সব পঠিত</button>
                    <button id="clear-all-notif-btn" class="clear-all-btn">সব মুছুন</button>
                </div>
            </div>
            <div id="notification-list-modal" class="notification-modal-body"></div>
        </div>
    </div>

    <!-- 7. Fullscreen Story Viewer -->
    <div id="storyViewerModal" style="display: none;">
        <div id="storyProgressBars"></div>
        <div id="storyUserInfo"></div>
        <button id="closeStoryViewerBtn">&times;</button>
        <div class="story-viewer-media"></div>
        
        <!-- Touch Areas for Navigation -->
        <div id="prevStoryBtn"></div>
        <div id="nextStoryBtn"></div>
        
        <div class="story-reply-container">
            <input type="text" placeholder="রিপ্লাই দিন..." class="story-reply-input">
            <button class="story-send-btn"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <!-- 8. Image Viewer Modal -->
    <div id="image-view-modal" class="image-modal">
        <span class="close-image-modal">&times;</span>
        <img class="image-modal-content" id="modal-image">
    </div>

    <!-- 9. SHORTS COMMENT MODAL (Bottom Sheet) -->
    <div id="shortsCommentModal" class="bottom-sheet-modal" style="display: none;">
        <div class="bottom-sheet-overlay" id="closeShortsModalOverlay"></div>
        <div class="bottom-sheet-content">
            
            <div class="sheet-handle-bar"></div>
            
            <div class="sheet-header">
                <h3 class="sheet-title">কমেন্ট <span id="shortsCommentCount">(0)</span></h3>
                <button class="sheet-close-btn" id="closeShortsModalBtn">
                    &times;
                </button>
            </div>

            <div id="shortsCommentsList" class="sheet-body">
                <div class="loader-container" style="display: flex; justify-content: center; padding: 20px;">
                    <div class="loader" style="border-color: #666; border-bottom-color: transparent;"></div>
                </div>
            </div>

            <div class="sheet-footer">
                <form id="shortsCommentForm">
                    <input type="hidden" id="shortsPostId">
                    <div class="sheet-input-wrapper">
                        <div class="sheet-avatar" id="myShortsAvatar"></div>
                        <input type="text" id="shortsCommentInput" placeholder="একটি কমেন্ট লিখুন..." autocomplete="off">
                        <button type="submit" id="submitShortsCommentBtn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scroll To Top Button -->
    <button id="scrollToTopBtn" class="scroll-to-top-btn" title="উপরে যান">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!-- ============================================= -->
    <!-- SCRIPTS (LOAD ORDER IS CRITICAL)              -->
    <!-- ============================================= -->
    
    <!-- 1. External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- 2. Application Modules (Loading in sequence) -->
    <script src="config.js"></script>
    <script src="utils.js"></script>
    <script src="auth.js"></script>
    <script src="stories.js"></script>
    <script src="feed.js"></script>
    <!-- interactions.js এর ভিতরেই ব্যাজ আপডেটের লজিক আছে -->
    <script src="interactions.js"></script>
    
    <!-- 3. MAIN ENTRY POINT (App Starts Here) -->
    <script src="main.js"></script>

    <!-- 4. Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js').catch(console.error);
        }
    </script>
</body>
</html>